name: Ghost Continuous Loop

on:
  push:
    branches: [ main ]
  workflow_dispatch: # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é
  repository_dispatch: # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å —á–µ—Ä–µ–∑ API (—Å–∞–º–æ–∑–∞–ø—É—Å–∫)
    types: [ restart_bot ]

jobs:
  run-ghost:
    runs-on: ubuntu-latest
    # –°—Ç–∞–≤–∏–º —á—É—Ç—å –±–æ–ª—å—à–µ 2 —á–∞—Å–æ–≤, —á—Ç–æ–±—ã —Å–∫—Ä–∏–ø—Ç —É—Å–ø–µ–ª —Å–∞–º —Å–µ–±—è –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
    timeout-minutes: 130 

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: pip install telethon requests

      - name: Run Engine & Self-Restart
        env:
          TG_API_ID: ${{ secrets.TG_API_ID }}
          TG_API_HASH: ${{ secrets.TG_API_HASH }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
          python main.py &
          BOT_PID=$!
          
          echo "üöÄ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω —Å PID $BOT_PID. –ñ–¥–µ–º 1 —á–∞—Å 50 –º–∏–Ω—É—Ç –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º..."
          
          # 2. –ñ–¥–µ–º 110 –º–∏–Ω—É—Ç (1 —á–∞—Å 50 –º–∏–Ω—É—Ç)
          sleep 6600
          
          echo "üîÑ –í—Ä–µ–º—è –≤—ã—à–ª–æ. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∏–≥–Ω–∞–ª –Ω–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫..."
          
          # 3. –ú–∞–≥–∏—è: –∑–∞—Å—Ç–∞–≤–ª—è–µ–º GitHub –∑–∞–ø—É—Å—Ç–∏—Ç—å —ç—Ç–æ—Ç –∂–µ –≤–æ—Ä–∫—Ñ–ª–æ—É –∑–∞–Ω–æ–≤–æ
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d '{"event_type": "restart_bot"}'
          
          echo "‚úÖ –°–∏–≥–Ω–∞–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –£–±–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –±–æ—Ç–∞."
          kill $BOT_PID
