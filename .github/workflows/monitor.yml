name: Festka Bot Infinite

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 */5 * * *'
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: üì• –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v3

      - name: üêç –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫
        run: pip install telethon

      - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ –∏ —Å–µ–∫—Ä–µ—Ç–æ–≤
        env:
          SESSION_CHECK: ${{ secrets.STRING_SESSION }}
        run: |
          ls -la
          if [ -z "$SESSION_CHECK" ]; then
            echo "‚ùå –û–®–ò–ë–ö–ê: –°–µ–∫—Ä–µ—Ç STRING_SESSION –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω!"
            exit 1
          else
            echo "‚úÖ –°–µ–∫—Ä–µ—Ç STRING_SESSION –Ω–∞–π–¥–µ–Ω."
          fi

      - name: üöÄ –ó–ê–ü–£–°–ö –ë–û–¢–ê
        env:
          API_ID: ${{ secrets.TG_API_ID }}
          API_HASH: ${{ secrets.TG_API_HASH }}
          SESSION_STR: ${{ secrets.STRING_SESSION }}
        # –£–±—Ä–∞–ª "|| echo", —Ç–µ–ø–µ—Ä—å –µ—Å–ª–∏ –æ–Ω —É–ø–∞–¥–µ—Ç ‚Äî –º—ã —É–≤–∏–¥–∏–º –æ—à–∏–±–∫—É
        # timeout 350m = 5 —á–∞—Å–æ–≤ 50 –º–∏–Ω—É—Ç (—á—É—Ç—å –º–µ–Ω—å—à–µ –ª–∏–º–∏—Ç–∞ –≥–∏—Ç—Ö–∞–±–∞)
        run: timeout 350m python3 main.py

      - name: üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Ü–∏–∫–ª–∞
        if: always() # –í—ã–ø–æ–ª–Ω–∏—Ç—å, –¥–∞–∂–µ –µ—Å–ª–∏ timeout —É–±–∏–ª –ø—Ä–æ—Ü–µ—Å—Å (—ç—Ç–æ –Ω–æ—Ä–º–∞)
        run: |
          curl -X POST -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          https://api.github.com/repos/${{ github.repository }}/actions/workflows/monitor.yml/dispatches \
          -d '{"ref":"main"}'
